<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - Dental Clinic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .calendar-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        .calendar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
        }
        .calendar-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            border: 1px solid #dee2e6;
        }
        .calendar-table td {
            border: 1px solid #dee2e6;
            padding: 0.5rem;
            height: 120px;
            vertical-align: top;
            position: relative;
        }
        .calendar-day {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .appointments-container {
            max-height: 80px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #007bff #f8f9fa;
        }
        .appointments-container::-webkit-scrollbar {
            width: 6px;
        }
        .appointments-container::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 3px;
        }
        .appointments-container::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 3px;
        }
        .appointments-container::-webkit-scrollbar-thumb:hover {
            background: #0056b3;
        }
        .appointment-count {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .other-month {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        .today {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }
        .appointment-item {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.5rem;
            margin: 0.1rem 0;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .appointment-item:hover {
            background: #0056b3;
            transform: scale(1.02);
        }
        .appointment-time {
            font-weight: bold;
            font-size: 0.7rem;
        }
        .appointment-patient {
            font-size: 0.7rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .appointment-care {
            font-size: 0.6rem;
            opacity: 0.9;
        }
        .past-appointment {
            background: #6c757d !important;
            opacity: 0.7;
        }
        .past-appointment:hover {
            background: #5a6268 !important;
            transform: none;
        }
        .past-indicator {
            font-size: 0.5rem;
            background: rgba(255,255,255,0.2);
            padding: 0.1rem 0.3rem;
            border-radius: 2px;
            margin-top: 0.1rem;
            text-align: center;
        }
        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            transform: translateY(-2px);
        }
        .stats-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }
        @media (max-width: 768px) {
            .calendar-table td {
                height: 80px;
                padding: 0.25rem;
            }
            .appointments-container {
                max-height: 60px;
            }
            .appointment-item {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
            .appointment-count {
                width: 18px;
                height: 18px;
                font-size: 0.6rem;
            }
        }
        .pagination .page-item.disabled .page-link {
            color: #6c757d;
            background-color: transparent;
        }
        
        /* Responsive Alert Styles */
        .alert-responsive {
            border: none;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            animation: slideInDown 0.3s ease-out;
        }
        
        .alert-responsive.alert-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border-left: 4px solid #dc3545;
        }
        
        .alert-responsive.alert-warning {
            background: linear-gradient(135deg, #ffd93d 0%, #ffc107 100%);
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .alert-responsive.alert-success {
            background: linear-gradient(135deg, #51cf66 0%, #28a745 100%);
            color: white;
            border-left: 4px solid #28a745;
        }
        
        .alert-responsive.alert-info {
            background: linear-gradient(135deg, #74c0fc 0%, #17a2b8 100%);
            color: white;
            border-left: 4px solid #17a2b8;
        }
        
        .alert-responsive .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        
        .alert-responsive .btn-close:hover {
            opacity: 1;
        }
        
        .alert-responsive .alert-icon {
            font-size: 1.1rem;
            margin-right: 0.75rem;
            display: inline-flex;
            align-items: center;
        }
        
        .alert-responsive .alert-content {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }
        
        .alert-responsive .alert-text {
            flex: 1;
            margin-right: 1rem;
        }
        
        .alert-responsive .alert-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Validation Messages */
        .validation-message {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 3px solid;
            animation: fadeInUp 0.3s ease-out;
        }
        
        .validation-message.validation-error {
            background: linear-gradient(135deg, #ffe6e6 0%, #ffebee 100%);
            color: #d32f2f;
            border-left-color: #f44336;
        }
        
        .validation-message.validation-success {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            color: #2e7d32;
            border-left-color: #4caf50;
        }
        
        .validation-message.validation-warning {
            background: linear-gradient(135deg, #fff8e1 0%, #fffde7 100%);
            color: #f57c00;
            border-left-color: #ff9800;
        }
        
        .validation-message.validation-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            color: #1976d2;
            border-left-color: #2196f3;
        }
        
        /* Form Validation Styles */
        .form-control.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='m5.8 4.6 1.4 1.4L5.8 7.4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .form-control.is-valid {
            border-color: #198754;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.94-.94 2.54 2.54 3.94-3.94.94.94-4.88 4.88z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .invalid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border-left: 3px solid #dc3545;
            animation: fadeInUp 0.3s ease-out;
        }
        
        .valid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #198754;
            background: rgba(25, 135, 84, 0.1);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border-left: 3px solid #198754;
            animation: fadeInUp 0.3s ease-out;
        }
        
        /* Animations */
        @keyframes slideInDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeInUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Responsive adjustments for alerts */
        @media (max-width: 768px) {
            .alert-responsive {
                padding: 0.875rem 1rem;
                font-size: 0.9rem;
                margin-bottom: 1rem;
            }
            
            .alert-responsive .alert-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .alert-responsive .alert-text {
                margin-right: 0;
                margin-bottom: 0.5rem;
            }
            
            .alert-responsive .alert-actions {
                align-self: flex-end;
            }
            
            .validation-message {
                font-size: 0.8rem;
                padding: 0.625rem;
            }
            
            .invalid-feedback,
            .valid-feedback {
                font-size: 0.8rem;
                padding: 0.375rem 0.625rem;
            }
        }
        
        @media (max-width: 576px) {
            .alert-responsive {
                padding: 0.75rem;
                font-size: 0.85rem;
            }
            
            .alert-responsive .alert-icon {
                font-size: 1rem;
                margin-right: 0.5rem;
            }
            
            .validation-message {
                font-size: 0.75rem;
                padding: 0.5rem;
            }
        }
        
        .toast-notification,
        .toast-notification.toast-success,
        .toast-notification.toast-error,
        .toast-notification.toast-warning,
        .toast-notification.toast-info {
            background: linear-gradient(135deg, #51cf66 0%, #28a745 100%) !important;
            color: white !important;
            border-left: 4px solid #28a745 !important;
        }
        
        /* Calendar Sliding Animation Styles */
        .calendar-slide-container {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }
        
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            transition: transform 0.5s ease-in-out;
        }
        
        .calendar-table.slide-left {
            transform: translateX(-100%);
        }
        
        .calendar-table.slide-right {
            transform: translateX(100%);
        }
        
        .calendar-table.slide-in {
            transform: translateX(0);
        }
        
        /* Loading overlay for smooth transitions */
        .calendar-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .calendar-loading.show {
            opacity: 1;
            visibility: visible;
        }
        
        .calendar-loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-tooth me-2"></i>Dental Clinic
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/appointments">Appointments</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/calendar">Calendar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/patients">Patients</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container text-center">
            <h1 class="display-5 fw-bold mb-3">
                <i class="fas fa-calendar-alt me-3"></i>Monthly Calendar
            </h1>
            <p class="lead mb-0">View all appointments in a monthly calendar view</p>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="py-4">
        <div class="container">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="stats-card">
                        <i class="fas fa-calendar-check fa-2x text-success mb-3"></i>
                        <h4 class="fw-bold">{{ appointments_by_date|length }}</h4>
                        <p class="text-muted mb-0">Days with Appointments</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                        <h4 class="fw-bold">{{ total_appointments }}</h4>
                        <p class="text-muted mb-0">Total Appointments</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <i class="fas fa-tooth fa-2x text-info mb-3"></i>
                        <h4 class="fw-bold">{{ month_name }}</h4>
                        <p class="text-muted mb-0">{{ year }}</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Calendar Section -->
    <section class="py-4">
        <div class="container">
            <div class="calendar-container">
                <!-- Calendar Header with Navigation -->
                <div class="calendar-header">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <button type="button" class="nav-btn" onclick="navigateMonth('prev')">
                                <i class="fas fa-chevron-left me-2"></i>Previous
                            </button>
                        </div>
                        <div class="col-md-4 text-center">
                            <h2 class="mb-0 fw-bold">{{ month_name }} {{ year }}</h2>
                        </div>
                        <div class="col-md-4 text-end">
                            <button type="button" class="nav-btn" onclick="navigateMonth('next')">
                                Next<i class="fas fa-chevron-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Calendar Table -->
                <div class="calendar-slide-container">
                    <div class="calendar-loading">
                        <div class="spinner"></div>
                    </div>
                    <div class="table-responsive">
                        <table class="calendar-table slide-in">
                            <thead>
                                <tr>
                                    <th>Sunday</th>
                                    <th>Monday</th>
                                    <th>Tuesday</th>
                                    <th>Wednesday</th>
                                    <th>Thursday</th>
                                    <th>Friday</th>
                                    <th>Saturday</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for week in calendar %}
                                <tr>
                                    {% for day in week %}
                                    {% set current_date = "%04d-%02d-%02d"|format(year, month, day) if day != 0 else "" %}
                                    {% set is_today = current_date == today_date if current_date else False %}
                                    {% set has_appointments = current_date in appointments_by_date %}
                                    <td class="{% if day == 0 %}other-month{% elif is_today %}today{% endif %}">
                                        {% if day != 0 %}
                                        <div class="calendar-day">{{ day }}</div>
                                        {% if has_appointments %}
                                            {% set appointment_count = appointments_by_date[current_date]|length %}
                                            {% if appointment_count > 3 %}
                                            <div class="appointment-count">{{ appointment_count }}</div>
                                            {% endif %}
                                            <div class="appointments-container">
                                                {% for appointment in appointments_by_date[current_date] %}
                                                {% set appointment_datetime = appointment[3] + ' ' + appointment[4] %}
                                                {% set is_past_appointment = appointment_datetime < current_datetime %}
                                                <div class="appointment-item {% if is_past_appointment %}past-appointment{% endif %}" 
                                                     data-id="{{ appointment[0] }}"
                                                     data-patient="{{ appointment[1] }}"
                                                     data-date="{{ appointment[3] }}"
                                                     data-time="{{ appointment[4] }}"
                                                     data-care="{{ appointment[5] }}"
                                                     data-is-past="{{ 'true' if is_past_appointment else 'false' }}">
                                                    <div class="appointment-time">{{ appointment[4]|ampm }}</div>
                                                    <div class="appointment-patient">{{ appointment[1] }}</div>
                                                    <div class="appointment-care">{{ appointment[5] }}</div>
                                                    {% if is_past_appointment %}
                                                    <div class="past-indicator">Past</div>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Action Buttons -->
    <section class="py-4">
        <div class="container">
            <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center">
                <a href="/" class="btn btn-primary btn-custom">
                    <i class="fas fa-home me-2"></i>Back to Home
                </a>
                <a href="/appointments" class="btn btn-success btn-custom">
                    <i class="fas fa-list me-2"></i>List View
                </a>
            </div>
        </div>
    </section>

    <!-- Appointment Details Modal -->
    <div class="modal fade" id="appointmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Appointment Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <p><strong>Patient:</strong> <span id="modal-patient"></span></p>
                            <p><strong>Date:</strong> <span id="modal-date"></span></p>
                            <p><strong>Time:</strong> <span id="modal-time"></span></p>
                            <p><strong>Dental Care:</strong> <span id="modal-care"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="modal-edit-btn" class="btn btn-primary">
                        <i class="fas fa-edit me-2"></i>Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Appointment Modal -->
    <div class="modal fade" id="editAppointmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Appointment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAppointmentForm">
                        <input type="hidden" id="edit-appointment-id" name="appointment_id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-name" class="form-label">Patient Name</label>
                                <input type="text" class="form-control" id="edit-name" name="name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-contact" class="form-label">Contact</label>
                                <input type="text" class="form-control" id="edit-contact" name="contact" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="edit-date" name="date" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-time" class="form-label">Time</label>
                                <select class="form-control" id="edit-time" name="time" required>
                                    <option value="">Select Time</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="edit-dental-care" class="form-label">Dental Care</label>
                                <input type="text" class="form-control" id="edit-dental-care" name="dental_care" required>
                            </div>
                        </div>
                        <div id="edit-error-message" class="alert-responsive alert-danger" style="display: none;">
                            <div class="alert-content">
                                <div class="alert-text">
                                    <i class="fas fa-exclamation-triangle alert-icon"></i>
                                    <span id="edit-error-text"></span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAppointment()">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 Dental Clinic. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function navigateMonth(direction) {
            const calendarTable = document.querySelector('.calendar-table');
            const loadingOverlay = document.querySelector('.calendar-loading');
            const currentYear = parseInt('{{ year }}');
            const currentMonth = parseInt('{{ month }}');
            
            // Calculate next/previous month
            let targetYear = currentYear;
            let targetMonth = currentMonth;
            
            if (direction === 'next') {
                if (currentMonth === 12) {
                    targetMonth = 1;
                    targetYear = currentYear + 1;
                } else {
                    targetMonth = currentMonth + 1;
                }
                calendarTable.classList.add('slide-right');
            } else {
                if (currentMonth === 1) {
                    targetMonth = 12;
                    targetYear = currentYear - 1;
                } else {
                    targetMonth = currentMonth - 1;
                }
                calendarTable.classList.add('slide-left');
            }
            
            // Show loading overlay
            loadingOverlay.classList.add('show');
            
            // Store current scroll position
            const scrollPosition = window.scrollY;
            
            // After animation completes, load new month content via AJAX
            setTimeout(() => {
                // Update URL without page reload
                const newUrl = `/calendar?year=${targetYear}&month=${targetMonth}`;
                if (window.scrollManager) {
                    window.scrollManager.preserveScrollOnNavigation(newUrl);
                } else {
                    window.location.href = newUrl;
                }
                
                // Fetch the new month content
                fetch(newUrl)
                    .then(response => response.text())
                    .then(html => {
                        // Create a temporary div to parse the HTML
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // Extract the calendar content
                        const newCalendarContent = tempDiv.querySelector('.calendar-container');
                        const currentCalendarContent = document.querySelector('.calendar-container');
                        
                        if (newCalendarContent && currentCalendarContent) {
                            // Replace the calendar content
                            currentCalendarContent.innerHTML = newCalendarContent.innerHTML;
                            
                            // Update the month/year display
                            const newMonthDisplay = tempDiv.querySelector('.month-year-display');
                            const currentMonthDisplay = document.querySelector('.month-year-display');
                            if (newMonthDisplay && currentMonthDisplay) {
                                currentMonthDisplay.innerHTML = newMonthDisplay.innerHTML;
                            }
                            
                            // Remove animation classes
                            calendarTable.classList.remove('slide-left', 'slide-right');
                            
                            // Hide loading overlay
                            loadingOverlay.classList.remove('show');
                            
                            // Restore scroll position
                            window.scrollTo(0, scrollPosition);
                            
                            // Re-initialize any necessary event listeners
                            initializeCalendarEvents();
                        } else {
                            // Fallback to full page reload if content extraction fails
                            if (window.scrollManager) {
                                window.scrollManager.preserveScrollOnNavigation(newUrl);
                            } else {
                                window.location.href = newUrl;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading new month:', error);
                        // Fallback to full page reload
                        if (window.scrollManager) {
                            window.scrollManager.preserveScrollOnNavigation(newUrl);
                        } else {
                            window.location.href = newUrl;
                        }
                    });
            }, 500);
        }
        
        // Function to re-initialize calendar event listeners
        function initializeCalendarEvents() {
            // Re-attach click handlers for appointment items
            document.addEventListener('click', function(e) {
                if (e.target.closest('.appointment-item')) {
                    const item = e.target.closest('.appointment-item');
                    const id = item.dataset.id;
                    const patient = item.dataset.patient;
                    const date = item.dataset.date;
                    const time = item.dataset.time;
                    const care = item.dataset.care;
                    
                    showAppointmentDetails(id, patient, date, time, care);
                }
            });
        }
        
        // Initialize calendar events when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCalendarEvents();
        });

        function showAppointmentDetails(id, patient, date, time, care) {
            // Format time to 12-hour format
            function formatTime12Hour(timeStr) {
                try {
                    const [hours, minutes] = timeStr.split(':');
                    const hour = parseInt(hours);
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const hour12 = hour % 12 || 12;
                    return `${hour12}:${minutes} ${ampm}`;
                } catch (e) {
                    return timeStr; // fallback to original if parsing fails
                }
            }
            
            document.getElementById('modal-patient').textContent = patient;
            document.getElementById('modal-date').textContent = date;
            document.getElementById('modal-time').textContent = formatTime12Hour(time);
            document.getElementById('modal-care').textContent = care;
            
            // Check if appointment is in the past
            const appointmentDatetime = date + ' ' + time;
            const currentDatetime = new Date().toISOString().slice(0, 16).replace('T', ' ');
            const isPastAppointment = appointmentDatetime < currentDatetime;
            
            const editBtn = document.getElementById('modal-edit-btn');
            if (isPastAppointment) {
                // Hide the edit button for past appointments
                editBtn.style.display = 'none';
            } else {
                // Show and enable the edit button for current/future appointments
                editBtn.style.display = 'inline-block';
                editBtn.disabled = false;
                
                // Remove any existing click handlers and add new one
                editBtn.replaceWith(editBtn.cloneNode(true));
                const newEditBtn = document.getElementById('modal-edit-btn');
                newEditBtn.addEventListener('click', function() {
                    openEditModal(id, patient, date, time, care);
                });
            }
            
            new bootstrap.Modal(document.getElementById('appointmentModal')).show();
        }

        function openEditModal(id, patient, date, time, care) {
            console.log('Opening edit modal for appointment:', id, patient, date, time, care);
            
            // Close the details modal first
            const detailsModal = bootstrap.Modal.getInstance(document.getElementById('appointmentModal'));
            if (detailsModal) {
                detailsModal.hide();
            }
            
            // Populate the edit form
            document.getElementById('edit-appointment-id').value = id;
            document.getElementById('edit-name').value = patient;
            document.getElementById('edit-contact').value = ''; // Will be populated from server
            document.getElementById('edit-date').value = date;
            
            // Populate time dropdown
            const timeSelect = document.getElementById('edit-time');
            timeSelect.innerHTML = '<option value="">Select Time</option>';
            
            // Generate time options (9 AM to 5 PM, 30-minute intervals)
            for (let hour = 9; hour < 18; hour++) {
                for (let minute of [0, 30]) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = timeStr;
                    option.textContent = timeStr;
                    if (timeStr === time) {
                        option.selected = true;
                    }
                    timeSelect.appendChild(option);
                }
            }
            
            document.getElementById('edit-dental-care').value = care;
            
            // Clear any previous error messages
            document.getElementById('edit-error-text').textContent = '';
            document.getElementById('edit-error-message').style.display = 'none';
            
            // Get contact information from server
            fetch(`/api/appointment/${id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        document.getElementById('edit-contact').value = data.appointment.contact;
                    } else {
                        console.error('Failed to fetch appointment details:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error fetching appointment details:', error);
                    // Set a placeholder or leave empty
                    document.getElementById('edit-contact').value = 'Contact info unavailable';
                });
            
            // Show the edit modal
            const editModal = new bootstrap.Modal(document.getElementById('editAppointmentModal'));
            editModal.show();
        }

        function saveAppointment() {
            const form = document.getElementById('editAppointmentForm');
            const formData = new FormData(form);
            
            const appointmentData = {
                name: formData.get('name'),
                contact: formData.get('contact'),
                date: formData.get('date'),
                time: formData.get('time'),
                dental_care: formData.get('dental_care')
            };

            console.log('Saving appointment data:', appointmentData);

            // Clear previous validation states
            clearEditValidationStates();
            
            // Check all required fields
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            const validationErrors = [];
            
            requiredFields.forEach(field => {
                const fieldValue = field.value.trim();
                const fieldName = field.name;
                const fieldLabel = field.closest('.col-md-6, .col-12').querySelector('label').textContent.replace('*', '').trim();
                
                if (!fieldValue) {
                    // Mark field as invalid only if it's blank
                    field.classList.add('is-invalid');
                    field.classList.remove('is-valid');
                    
                    // Show validation message only for blank fields
                    const feedback = field.nextElementSibling;
                    if (feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.style.display = 'block';
                    }
                    
                    // Add to validation errors list only for blank fields
                    validationErrors.push(`${fieldLabel} is required`);
                    isValid = false;
                } else {
                    // For non-blank fields, just remove invalid state but don't add valid state
                    field.classList.remove('is-invalid');
                    
                    // Hide validation message for non-blank fields
                    const feedback = field.nextElementSibling;
                    if (feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.style.display = 'none';
                    }
                }
            });
            
            // Additional validation for date
            const dateField = form.querySelector('input[type="date"]');
            if (dateField && dateField.value) {
                const today = new Date().toISOString().split('T')[0];
                if (dateField.value < today) {
                    dateField.classList.add('is-invalid');
                    dateField.classList.remove('is-valid');
                    validationErrors.push('Please select a current or future date');
                    isValid = false;
                }
            }
            
            // Show validation summary if there are errors
            if (!isValid) {
                showEditValidationSummary(validationErrors);
                return false;
            }

            // Send the updated appointment data to the server
            fetch('/edit/' + formData.get('appointment_id'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams(appointmentData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Close the edit modal
                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editAppointmentModal'));
                    if (editModal) {
                        editModal.hide();
                    }
                    
                    // Show responsive success message
                    showToastNotification('Appointment updated successfully!', 'success');
                    
                    // Reload the page after a short delay
                    setTimeout(() => {
                        if (window.scrollManager) {
                            window.scrollManager.preserveScrollOnNavigation('/calendar');
                        } else {
                            window.location.href = '/calendar';
                        }
                    }, 2000);
                } else {
                    document.getElementById('edit-error-text').textContent = data.error || 'An error occurred while updating the appointment.';
                    document.getElementById('edit-error-message').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('edit-error-text').textContent = 'An error occurred. Please try again later.';
                document.getElementById('edit-error-message').style.display = 'block';
            });
        }
        
        // Function to clear edit validation states
        function clearEditValidationStates() {
            const form = document.getElementById('editAppointmentForm');
            const fields = form.querySelectorAll('.form-control');
            fields.forEach(field => {
                field.classList.remove('is-invalid', 'is-valid');
                const feedback = field.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.style.display = 'none';
                }
            });
            
            // Remove any existing validation summary
            const existingSummary = document.querySelector('.edit-validation-summary');
            if (existingSummary) {
                existingSummary.remove();
            }
        }
        
        // Function to show edit validation summary
        function showEditValidationSummary(errors) {
            const form = document.getElementById('editAppointmentForm');
            
            // Remove any existing validation summary
            const existingSummary = document.querySelector('.edit-validation-summary');
            if (existingSummary) {
                existingSummary.remove();
            }
            
            // Create validation summary
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'edit-validation-summary alert-responsive alert-danger mt-3';
            summaryDiv.innerHTML = `
                <div class="alert-content">
                    <div class="alert-text">
                        <i class="fas fa-exclamation-triangle alert-icon"></i>
                        <strong>Please fix the following errors:</strong>
                        <ul class="mb-0 mt-2">
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="alert-actions">
                        <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                </div>
            `;
            
            // Insert before the form
            form.parentNode.insertBefore(summaryDiv, form);
            
            // Scroll to the summary
            summaryDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (summaryDiv.parentNode) {
                    summaryDiv.remove();
                }
            }, 10000);
        }
        
        // Function to show toast notification
        function showToastNotification(message, type) {
            // Remove any existing toast notifications
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());
            
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type} alert-responsive`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 9999;
                min-width: 300px;
                max-width: 500px;
                animation: slideInDown 0.3s ease-out;
            `;
            toast.innerHTML = `
                <div class="alert-content">
                    <div class="alert-text">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} alert-icon"></i>
                        ${message}
                    </div>
                    <div class="alert-actions">
                        <button type="button" class="btn-close" onclick="this.parentElement.parentElement.parentElement.remove()"></button>
                    </div>
                </div>
            `;
            
            // Add to body
            document.body.appendChild(toast);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html> 